#!/bin/bash
# arca-chat v30.4 - Retorno de Debug y Estad√≠sticas At√≥micas
source "$HOME/IA/arca.conf"
OPERADOR=$(whoami)

# 1. Par√°metros de Sistema y Debug
DEBUG_MODE=true
[[ "$1" == "--debug" ]] && DEBUG_MODE=true

TOTAL_RAM_GB=$(free -g | awk '/^Mem:/{print $2}')
if [ "$TOTAL_RAM_GB" -ge 15 ]; then
    VENTANA_CONTEXTO=4096
    NUM_RESULTADOS=3
else
    VENTANA_CONTEXTO=2048
    NUM_RESULTADOS=2
fi

clear
echo "===================================================================="
echo "   üõ°Ô∏è  SISTEMA ARCA - N√öCLEO v30.4 (Atomic-RAG Focus)"
echo "   üìä RAM: ${TOTAL_RAM_GB}GB | Contexto: ${VENTANA_CONTEXTO} tokens"
echo "===================================================================="

while true; do
    echo -ne "\nüë§ *$OPERADOR*: "
    read -re PREGUNTA
    [[ "$PREGUNTA" =~ ^(/)?(salir|exit|quit)$ ]] && break
    [ -z "$PREGUNTA" ] && continue

    T_START=$(date +%s.%N) # Inicio cron√≥metro
    
    echo -ne "üîç Consultando engramas..."
    
    # 2. B√∫squeda At√≥mica
    # Capturamos la salida sin procesar para el debug si es necesario
    RAW_SEARCH=$(arca-atomic-search "$PREGUNTA")
    CONTEXTO_RECUPERADO=$(echo "$RAW_SEARCH" | sed -n '/---CONTEXT---/,$p' | sed '/---/d' | grep -v "^$")

#echo RAW_SEARCH=$RAW_SEARCH
#echo CONTEXTO_RECUPERADO=$CONTEXTO_RECUPERADO

    # 3. Construcci√≥n del Prompt
    if [ -n "$CONTEXTO_RECUPERADO" ]; then
        PROMPT="Act√∫a como el bibliotecario de la biblioteca del Arca. Responde de forma T√âCNICA, BREVE y DIRECTA bas√°ndote exclusivamente en estos recuerdos:
        
        $CONTEXTO_RECUPERADO
        
        Pregunta: $PREGUNTA"
        ORIGEN="Memoria At√≥mica (Engramas)"
    else
        PROMPT="Responde que no tienes informaci√≥n local sobre: $PREGUNTA"
        ORIGEN="IA (Conocimiento General)"
    fi

    # 4. MODO DEBUG: Visualizaci√≥n del "Pensamiento" local
    if [ "$DEBUG_MODE" = true ]; then
        echo -e "\n\n[DEBUG ARCA - Nivel At√≥mico]"
        echo -e "üìë Bloques recuperados ($NUM_RESULTADOS):\n$CONTEXTO_RECUPERADO"
        echo -e "----------------------------------------------------"
    fi

    # 5. Inferencia con Ollama
    echo -ne "\rü§ñ Generando respuesta..."
    RESPUESTA=$(ollama run "$MODELO" "$PROMPT" 2>/dev/null)
    
    T_END=$(date +%s.%N)
    T_TOTAL=$(echo "$T_END - $T_START" | bc) # C√°lculo de tiempo total

    # 6. Salida Final y Estad√≠sticas
    echo -e "\r--- RESPUESTA DEL SISTEMA ---"
    echo -e "$RESPUESTA"
    echo -e "\n--------------------------------------------------------------------"
    echo -e "‚è±Ô∏è  Tiempo: ${T_TOTAL}s | üìö Origen: $ORIGEN | üß† Modelo: $MODELO"
    echo "--------------------------------------------------------------------"
done

