#!/bin/bash
# arca-chat v28.2 - Eliminaci√≥n de errores de grep mediante sed
source "$HOME/IA/arca.conf"
OPERADOR=$(whoami)

clear
echo "===================================================================="
echo "   üõ°Ô∏è  SISTEMA ARCA - N√öCLEO v28.2 (Robust Parsing)"
echo "===================================================================="

while true; do
    echo -ne "\nüë§ *$OPERADOR*: "
    read -re PREGUNTA
    [[ "$PREGUNTA" =~ ^(/)?(salir|exit|quit)$ ]] && break
    [ -z "$PREGUNTA" ] && continue

    T_START=$(date +%s)
    
    # --- PASO 1: Delegar b√∫squeda a arca-search ---
    RAW_SEARCH=$(./arca-search "$PREGUNTA")
    
    # PASO 2: Procesamiento de Metadatos (Usamos sed para limpiar los separadores antes de filtrar)
    # Eliminamos las l√≠neas que contienen '---' antes de pasarlas a grep o xargs
    KEYWORDS=$(echo "$RAW_SEARCH" | sed -n '/---KEYWORDS---/,/---SOURCES---/p' | sed '/---/d')
    
    # Extraemos fuentes y limpiamos duplicados
    FUENTES=$(echo "$RAW_SEARCH" | sed -n '/---SOURCES---/,/---CONTEXT---/p' | sed '/---/d' | sort -u | xargs)
    
    # --- PASO 3: Filtro de los 2 mejores resultados (Top-2) ---
    # Extraemos el bloque de CONTEXTO y seleccionamos los 2 scores m√°s altos
    CONTEXTO_TOP=$(echo -e "$RAW_SEARCH" | sed -n '/---CONTEXT---/,$p' | sed '/---/d' | grep "SCORE:" | sort -rnk2 | head -n 2)

    # --- PASO 4: Generaci√≥n de Respuesta ---
    if [ -n "$CONTEXTO_TOP" ]; then
        PROMPT="Responde de forma t√©cnica y breve usando este CONTEXTO (los 2 mejores hallazgos):\n$CONTEXTO_TOP\n\nPregunta: $PREGUNTA"
        ORIGEN="Manuales Locales (Filtrado Top-2)"
    else
        PROMPT="Responde de forma general a: $PREGUNTA"
        ORIGEN="IA General"
    fi

    # Ejecuci√≥n del modelo configurado
    RESPUESTA=$(echo -e "$PROMPT" | ollama run "$MODELO")
    T_END=$(date +%s)
    T_TOTAL=$((T_END - T_START))

    # --- SALIDA FINAL ---
    echo -e "\n$RESPUESTA"
    echo -e "\n--------------------------------------------------------------------"
    echo -e "üìö Fuente: $ORIGEN | üîë Keys: [$KEYWORDS]"
    echo -e "üìñ Libros: ${FUENTES:-Ninguno}"
    echo -e "‚è±Ô∏è  Proceso total: ${T_TOTAL}s"
    echo -e "--------------------------------------------------------------------"
done
