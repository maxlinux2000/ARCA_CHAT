#!/bin/bash
# arca-search v4.2 - Fix comillas desemparejadas y blindaje xargs
set -e
source "$HOME/IA/arca.conf"
VECTORES="$HOME/IA/vectors"
MEMVID_BIN="/opt/arca/bin/memvid"
MODELO_EXTRACTOR="arca-extractor"

[ -z "$1" ] && exit 0
PREGUNTA="$1"

# PASO 1: Extracción de Keywords
KEYWORDS=$(ollama run "$MODELO_EXTRACTOR" "$PREGUNTA" 2>/dev/null | tr -d '*•-' | sed 's/[[:punct:]]//g' | xargs)

# PASO 2: Función de búsqueda modular
ejecutar_busqueda() {
    local UMBRAL=$1
    local RESULTADOS_CICLO=""
    local FUENTES_CICLO=""

    for index_file in "$VECTORES"/*.mv2; do
        [ -e "$index_file" ] || continue
        NOMBRE_LIBRO=$(basename "$index_file" .mv2)
        
        BUSQUEDA=$($MEMVID_BIN --db "$index_file" --search "$KEYWORDS" --threshold "$UMBRAL" 2>/dev/null)
        
        if [ -n "$BUSQUEDA" ]; then
            RESULTADOS_CICLO+="\n[FUENTE: $NOMBRE_LIBRO (Confianza: $UMBRAL)]\n$BUSQUEDA\n"
            FUENTES_CICLO+="$NOMBRE_LIBRO "
        fi
    done
    
    echo -e "---SOURCES---\n$FUENTES_CICLO\n---CONTEXT---\n$RESULTADOS_CICLO"
}

# PASO 3: Lógica de Cascada (80% -> 60% -> 35%)
echo "---KEYWORDS---"
echo "$KEYWORDS"

# Ciclo 1: Alta Precisión (0.80)
FINAL_OUTPUT=$(ejecutar_busqueda "0.80")
# CORRECCIÓN: Usamos grep -q para verificar contenido sin pasar por xargs 
if ! echo -e "$FINAL_OUTPUT" | sed -n '/---CONTEXT---/,$p' | grep -v -- "---" | grep -q "SCORE:"; then
    # Ciclo 2: Precisión Media (0.60)
    FINAL_OUTPUT=$(ejecutar_busqueda "0.60")
    if ! echo -e "$FINAL_OUTPUT" | sed -n '/---CONTEXT---/,$p' | grep -v -- "---" | grep -q "SCORE:"; then
        # Ciclo 3: Búsqueda Permisiva (0.35)
        FINAL_OUTPUT=$(ejecutar_busqueda "0.35")
    fi
fi

echo -e "$FINAL_OUTPUT"
