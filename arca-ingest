#!/bin/bash
# arca-ingest v15.1 - Un índice (.mv2) y un video (.mp4) por libro
set -e

MEMVID_BIN="/opt/arca/bin/memvid"
VECTORES="$HOME/IA/vectors"
TEMP_DIR="$HOME/.arca_temp"
MAX_BYTES=2100 
FPS=10 

[ -z "$1" ] && echo "Error: Falta archivo de entrada" && exit 1
FILE_PATH=$(realpath "$1")

# Extraemos el nombre base limpio para los archivos de salida 
ID_LIBRO=$(basename "$FILE_PATH" | sed 's/\.[^.]*$//' | tr ' ' '_')
LIBRO_INDEX="$VECTORES/${ID_LIBRO}.mv2"
LIBRO_VIDEO="$VECTORES/${ID_LIBRO}.mp4"

rm -rf "$TEMP_DIR"
mkdir -p "$TEMP_DIR/chunks" "$TEMP_DIR/frames" "$VECTORES"

echo "--- 1. Extracción y Purificación de Texto ---"
pdftotext -layout "$FILE_PATH" "$TEMP_DIR/raw.txt"
# Eliminamos caracteres no imprimibles y normalizamos espacios [cite: 6, 7]
perl -CSD -Mutf8 -pe 's/[^\p{Print}\s]//g' "$TEMP_DIR/raw.txt" | tr -s '[:space:]' ' ' > "$TEMP_DIR/full.txt"

echo "--- 2. Fragmentación ---"
CH_COUNT=1
CURRENT_SIZE=0
while read -r word; do
    WORD_SIZE=$(echo -n "$word " | wc -c)
    if [ $((CURRENT_SIZE + WORD_SIZE)) -gt $MAX_BYTES ]; then
        CH_COUNT=$((CH_COUNT + 1))
        CURRENT_SIZE=0
    fi
    TARGET_FILE="$TEMP_DIR/chunks/${ID_LIBRO}_chunk_$(printf "%06d" $CH_COUNT).txt"
    echo -n "$word " >> "$TARGET_FILE"
    CURRENT_SIZE=$((CURRENT_SIZE + WORD_SIZE))
done < <(cat "$TEMP_DIR/full.txt" | tr ' ' '\n')

echo "--- 3. Generación de Evidencia Visual (QR) ---"
cd "$TEMP_DIR/chunks"
for f in *.txt; do
    NUM=$(echo "$f" | grep -oP '\d+')
    # Generamos frames para el video 
    ZXingWriter -size 1024x1024 -margin 2 -ecc 0 -encoding UTF-8 QRCode "$(cat "$f")" "$TEMP_DIR/frames/frame_$NUM.png"
done

echo "--- 4. Compresión de Video de Referencia ---"
# Salida directa a .mp4 con el nombre del libro 
ffmpeg -y -framerate $FPS -pattern_type glob -i "$TEMP_DIR/frames/*.png" \
       -c:v libx264 -pix_fmt yuv420p "$LIBRO_VIDEO" -loglevel error

echo "--- 5. Generación de Base de Datos Vectorial Individual ---"
# Creamos un archivo .mv2 independiente para este libro 
$MEMVID_BIN --output-index "$LIBRO_INDEX" --input-dir "$TEMP_DIR/chunks"

rm -rf "$TEMP_DIR"
echo "✅ PROCESO COMPLETADO"
echo "Libro: $ID_LIBRO"
echo "Vector: $LIBRO_INDEX"
echo "Video: $LIBRO_VIDEO"


