#!/bin/bash
# arca-chat v16.8 - Orquestador con Metadatos SOURCE/ID
# --------------------------------------------------

CONF_FILE="$HOME/IA/arca.conf"
source "$CONF_FILE"
VECTORES="$HOME/IA/vectors"
MEMVID_BIN="/opt/arca/bin/memvid"
INDEX_MV2="$VECTORES/index.mv2"

clear
echo "===================================================================="
echo "   üõ°Ô∏è  SISTEMA ARCA - N√öCLEO OPERATIVO v16.8"
echo "        CEREBRO: $MODELO | RASTREADOR: Hunter v1.8"
echo "===================================================================="

while true; do
    echo -ne "\nüë§ **Operador:** "
    read -r PREGUNTA

    [[ "$PREGUNTA" =~ ^(/)?(salir|exit|quit)$ ]] && break
    [ -z "$PREGUNTA" ] && continue
    echo -ne "üîé *Consultando archivos...*"

    # 1. B√∫squeda sem√°ntica usando el nuevo formato de salida
    RAW_OUT=$($MEMVID_BIN --search "$PREGUNTA" --db "$INDEX_MV2" 2>/dev/null)

    if [ -z "$RAW_OUT" ]; then
        echo -ne "\r‚ö†Ô∏è  Sin evidencias directas.                             \n"
        continue
    fi

    CONTEXTO_UNIFICADO=""
    LISTADO_FUENTES=""
    
    # 2. Procesamiento de l√≠neas SOURCE: | ID: | TEXT:
    while read -r LINEA; do
        # Extraer campos mediante delimitador '|'
        S_NAME=$(echo "$LINEA" | awk -F' | ' '{print $1}' | sed 's/SOURCE: //')
        C_ID=$(echo "$LINEA" | awk -F' | ' '{print $2}' | sed 's/ID: //')
        
        echo -ne "\rüéØ *Hunter analizando $S_NAME...* "
        
        # Hunter v1.8 localiza el video exacto por el ID
        TEXTO_REAL=$(./hunter "$C_ID")
        
        if [ -n "$TEXTO_REAL" ]; then
            TEXTO_LIMP=$(echo "$TEXTO_REAL" | sed 's/^QRCode //;s/^"//;s/"$//')
            CONTEXTO_UNIFICADO+="\n[DOC: $S_NAME | ID: $C_ID]: $TEXTO_LIMP\n"
            LISTADO_FUENTES+="\n   - $S_NAME ($C_ID)"
        fi
    done <<< "$(echo "$RAW_OUT" | head -n 3)"

    # 3. Respuesta de la IA
    echo -ne "\rü§ñ **ARCA redactando informe t√©cnico...** \r"
    PROMPT="Eres ARCA. Responde brevemente bas√°ndote en:\n$CONTEXTO_UNIFICADO\n\nPregunta: $PREGUNTA"
    RESPUESTA_IA=$(echo -e "$PROMPT" | ollama run "$MODELO")

    echo -e "\n$RESPUESTA_IA"
    echo -e "\nüìö **Fuentes:**$LISTADO_FUENTES"
    echo -e "\n--------------------------------------------------------------------"
done
