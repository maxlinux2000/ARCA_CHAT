#!/bin/bash

source $HOME/IA/arca.conf 
# arca-chat v15.6 - Mejoras de Salida y Robustez
set -e

export LC_ALL=C.UTF-8
export LANG=C.UTF-8

MEMVID_BIN="/opt/arca/bin/memvid"
VECTORES="$HOME/IA/vectors"
INDEX_MV2="$VECTORES/index.mv2"
TEMP_DIR="$HOME/.arca_temp/search"
FPS=10 
#MODELO="llama3.2"

# --- CONFIGURACIÃ“N DE DEBUG ---
DEBUG=true
log_debug() { if [ "$DEBUG" = true ]; then echo -e "\e[33m[DEBUG] $1\e[0m"; fi; }

mkdir -p "$TEMP_DIR"
ARG_INICIAL="$1"

clear
echo "===================================================================="
echo "   ðŸ›¡ï¸  SISTEMA ARCA - NÃšCLEO DE INTELIGENCIA CONVERSACIONAL v15.6"
echo "        (Comandos de salida: /salir o /exit | Debug: ON)"
echo "===================================================================="

while true; do
    if [ -n "$ARG_INICIAL" ]; then
        PREGUNTA="$ARG_INICIAL"
        ARG_INICIAL=""
    else
        echo -ne "\nðŸ‘¤ **Operador:** "
        read -r PREGUNTA
    fi

    # LÃ³gica de salida mejorada (acepta con o sin barra) 
    if [[ "$PREGUNTA" =~ ^(/)?(salir|exit|quit)$ ]]; then
        echo -e "\n[!] Cerrando protocolos de comunicaciÃ³n de forma segura..."
        rm -f "$TEMP_DIR"/*.png # Limpieza de temporales al salir 
        break
    fi

    [ -z "$PREGUNTA" ] && continue

    echo -ne "ðŸ”Ž *Consultando archivos...*"

    # 1. BÃºsqueda de ventana contextual 
    RAW_OUT=$($MEMVID_BIN --search "$PREGUNTA" --db "$INDEX_MV2" 2>&1)
    CHUNKS_FOUND=$(echo "$RAW_OUT" | grep -oP 'SOURCE: \Kchunk_\d+' | head -n 3 | sort -u)

    if [ -z "$CHUNKS_FOUND" ]; then
        echo -e "\râŒ **ARCA:** No se hallaron referencias visuales para la consulta."
        continue
    fi

    # 2. RecuperaciÃ³n Multimodal
    CONTEXTO_UNIFICADO=""
    VIDEO_FILE=$(ls $VECTORES/*_qr.mp4 2>/dev/null | head -n 1)

    log_debug "Iniciando recuperaciÃ³n de ventana contextual..."

    for CHUNK_NAME in $CHUNKS_FOUND; do
        CHUNK_NUM=$(echo "$CHUNK_NAME" | grep -oP '\d+')
        CHUNK_INT=$((10#$CHUNK_NUM))
        TIME_RAW=$(echo "scale=2; $CHUNK_INT / $FPS" | bc -l)
        TIME_SECONDS=$(printf "%0.2f" "$TIME_RAW" 2>/dev/null || echo "0$TIME_RAW")
        
        TEXTO_PIEZA=""
        if [ -f "$VIDEO_FILE" ]; then
            log_debug "Analizando evidencia: $CHUNK_NAME a ${TIME_SECONDS}s"
            # Silenciamos FFmpeg totalmente para evitar logs de I/O molestos 
            ffmpeg -y -ss "$TIME_SECONDS" -i "$VIDEO_FILE" -frames:v 1 "$TEMP_DIR/temp_frame.png" -hide_banner -loglevel quiet >/dev/null 2>&1
            
            # Solo intentamos leer si el archivo existe
            if [ -f "$TEMP_DIR/temp_frame.png" ]; then
                TEXTO_PIEZA=$(ZXingReader -1 "$TEMP_DIR/temp_frame.png" 2>/dev/null | sed 's/^[^ ]* //' || echo "")
            fi
        fi

        [ -z "$TEXTO_PIEZA" ] && TEXTO_PIEZA=$(echo "$RAW_OUT" | grep "$CHUNK_NAME" -A 1 | tail -n 1)
        CONTEXTO_UNIFICADO+="\n[Fragmento $CHUNK_NAME]: $TEXTO_PIEZA\n"
    done

    # 3. Bypass y Respuesta [cite: 16, 17]
    echo -ne "\rðŸ¤– **ARCA analizando ventana de contexto...**\r"
    PREGUNTA_IA=$(echo "$PREGUNTA" | sed -e 's/preparacionismo/protecciÃ³n civil/gI' -e 's/supervivencia/resiliencia/gI')

    PROMPT="CONTEXTO TÃ‰CNICO: $CONTEXTO_UNIFICADO \n\n PREGUNTA: $PREGUNTA_IA"

    START_TIME=$(date +%s)
    echo -e "$PROMPT" | ollama run "$MODELO"
    END_TIME=$(date +%s)
    
    log_debug "AnÃ¡lisis completado en $((END_TIME - START_TIME))s"
    echo -e "\n--------------------------------------------------------------------"
done
