#!/bin/bash
# arca-search v2.1: Correcci√≥n de parseo de metadatos y soporte de caracteres especiales
set -e

source "$HOME/IA/arca.conf"
MEMVID_BIN="/opt/arca/bin/memvid"
VECTORES="$HOME/IA/vectors"
MASTER_INDEX="$VECTORES/index.mv2"
FPS=10

[ -z "$1" ] && echo "Uso: arca-search \"pregunta\"" && exit 1
PREGUNTA="$1"

echo "üîé Buscando coincidencias exactas en la biblioteca..."

# 1. Ejecuci√≥n de la b√∫squeda y captura de la salida
# Eliminamos posibles errores de la salida est√°ndar para no ensuciar la variable
RESULTADOS=$($MEMVID_BIN --search "$PREGUNTA" --db "$MASTER_INDEX" 2>/dev/null | head -n 1)

if [ -z "$RESULTADOS" ]; then
    echo "‚ùå No se encontraron evidencias para esa consulta."
    exit 1
fi

# 2. Extracci√≥n de Metadatos con robustez mejorada
# Usamos un m√©todo m√°s directo para evitar problemas con espacios y caracteres especiales
ID_DOC=$(echo "$RESULTADOS" | sed -n 's/.*SOURCE: \(.*\) | ID: .*/\1/p')
CHUNK_FULL_ID=$(echo "$RESULTADOS" | sed -n 's/.*ID: \(.*\) | TEXT: .*/\1/p')
FRAGMENTO=$(echo "$RESULTADOS" | sed -n 's/.*TEXT: \(.*\)/\1/p')

# 3. Calcular el timestamp bas√°ndonos en el n√∫mero de chunk
# Extraemos el n√∫mero final despu√©s del √∫ltimo gui√≥n bajo o 'chunk_'
CHUNK_NUM=$(echo "$CHUNK_FULL_ID" | grep -oP 'chunk_\K\d+' | sed 's/^0*//')
[ -z "$CHUNK_NUM" ] && CHUNK_NUM=0

# Tiempo = Frame (Chunk) / FPS
TIME_SECONDS=$(echo "scale=2; $CHUNK_NUM / $FPS" | bc -l)
TIMESTAMP=$(date -d@${TIME_SECONDS%.*} -u +%H:%M:%S 2>/dev/null || echo "00:00:00")

# 4. Mostrar informe de localizaci√≥n (Limpiando nombres de archivos)
# El nombre del video no lleva los par√©ntesis del t√≠tulo si lo limpiaste en el ingest
VIDEO_FILE="${ID_DOC}_qr.mp4"

echo -e "\nüéØ EVIDENCIA LOCALIZADA:"
echo "--------------------------------------------------------------------"
echo "üìñ Libro:    $ID_DOC"
echo "üé• Archivo:  $VIDEO_FILE"
echo "‚è±Ô∏è  Tiempo:   [$TIMESTAMP] (segundo $TIME_SECONDS)"
echo "üìù Fragmento: $FRAGMENTO"
echo "--------------------------------------------------------------------"
